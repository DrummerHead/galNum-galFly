var $ = require('selector');

var galUi = (function(){
  return {
    defaultShift: 25,
    currentImage: 0,
    minImage: 0,
    maxImage: this.defaultShift,

    init: function(galWidthElement){
      var _this = this;
      _this.galWidth = parseInt(getComputedStyle(galWidthElement).getPropertyValue('width'), 10);
      onkeypress = function(e){
        if(e.charCode == 106){
          _this.goToImage(true);
        }
        else if(e.charCode == 107){
          _this.goToImage(false);
        }
        else if(e.charCode == 108){
          _this.zoom($('#a' + _this.currentImage));
        }
      };
      $('#down').addEventListener('click', function(){
        _this.goToImage(true);
      });
      $('#up').addEventListener('click', function(){
        _this.goToImage(false);
      });
      $('#zoom').addEventListener('click', function(){
        _this.zoom($('#a' + _this.currentImage));
      });
      $('#light').addEventListener('click', function(){
        this.count = this.count ? (this.count + 1) % 3 : 1;
        switch(this.count){
          case 0:
            var color = "#808080";
          break;
          case 1:
            var color = "#000";
          break;
          case 2:
            var color = "#fff";
          break;
        }
        document.body.style.backgroundColor = color;
      });
    },

    goToImage: function(isGoingDown){
      if(isGoingDown){
        if((this.currentImage + 1) >= this.maxImage){
          scrollTo(0, document.body.scrollHeight);
          this.resumeWebm(this.currentImage, false);
        }
        else{
          this.resumeWebm(this.currentImage, false);
          scrollTo(0, $('#a' + ++this.currentImage).offsetTop - 5);
          this.resumeWebm(this.currentImage, true);
        }
      }
      else{
        if((this.currentImage - 1) >= this.minImage){
          this.resumeWebm(this.currentImage, false);
          scrollTo(0, $('#a' + --this.currentImage).offsetTop - 5);
          this.resumeWebm(this.currentImage, true);
        }
      }
    },

    fullScreen: function(el){
      if (el.requestFullscreen) {
        el.requestFullscreen();
      } else if (el.mozRequestFullScreen) {
        el.mozRequestFullScreen();
      } else if (el.webkitRequestFullscreen) {
        el.webkitRequestFullscreen();
      }
      el.fs = true;
    },

    exitFullscreen: function(el){
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      }
      el.fs = false;
    },

    zoom: function(el){
      if(el.nodeName === 'IMG'){
        var t = el.currentTarget || el;
        var newWidth = t.naturalWidth * (t.ct + 1);
        if(newWidth <= this.galWidth){
          t.ct++;
          t.setAttribute('style', 'width:' + newWidth + 'px;height:' + t.naturalHeight * t.ct + 'px');
        }
        else{
          t.ct = 0;
          t.setAttribute('style', 'width:100%');
        }
      }
      else if(el.nodeName === 'VIDEO'){
        if(el.fs){
          this.exitFullscreen(el);
        }
        else {
          this.fullScreen(el);
        }
      }
    },

    resumeWebm: function(id, willPlay){
      var element = $('#a' + id);
      if(element.nodeName === 'VIDEO'){
        if(willPlay){
          element.play();
        }
        else {
          element.pause();
          if(element.fs){
            this.exitFullscreen(element);
          }
        }
      }
    },

    bindResize: function(imgs){
      for(var i = 0; i < imgs.length; i++){
        var I = imgs.item(i);
        I.ct = 1;
        I.addEventListener('click', this.zoom.bind(this));
      }
    }
  }
})();

module.exports = galUi;
